<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Chips</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 600px; margin-top: 30px; }
        .scanner-container { display: none; text-align: center; }
        video { width: 90%; height: 120px; border: 2px solid #007bff; object-fit: cover; }
        .readonly-input { background-color: #e9ecef; }
    </style>
</head>
<body>
<div class="container shadow p-4 bg-white rounded">
    <h3 class="text-center">Formulario de Registro de Chips</h3>
    <form id="chipForm">
        <div class="mb-3"><label class="form-label">Nombre</label>
            <input type="text" name="nombre" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">DNI</label>
            <input type="text" name="dni" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Punto de Venta</label>
            <input type="text" name="punto" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Celular</label>
            <input type="text" name="celular" class="form-control"></div>
        <div class="mb-3"><label class="form-label">Serie Inicio</label>
            <div class="input-group">
                <input type="text" id="serieInicio" name="serieInicio" class="form-control" oninput="calcularCantidad()">
                <button type="button" class="btn btn-outline-secondary" onclick="startScanner('serieInicio')">üì∑</button>
                <input type="file" accept="image/*" capture="camera" class="btn btn-outline-info" onchange="scanFromImage(event, 'serieInicio')">
            </div>
        </div>
        <div class="mb-3"><label class="form-label">Serie Final</label>
            <div class="input-group">
                <input type="text" id="serieFinal" name="serieFinal" class="form-control" oninput="calcularCantidad()">
                <button type="button" class="btn btn-outline-secondary" onclick="startScanner('serieFinal')">üì∑</button>
                <input type="file" accept="image/*" capture="camera" class="btn btn-outline-info" onchange="scanFromImage(event, 'serieFinal')">
            </div>
        </div>
        <div class="mb-3"><label class="form-label">Cantidad de ICID</label>
            <input type="text" id="cantidad" name="cantidad" class="form-control readonly-input" readonly></div>
        <div class="mb-3"><label class="form-label">Fecha de Registro</label>
            <input type="text" id="fecha" name="fecha" class="form-control readonly-input" readonly></div>
        <button type="submit" class="btn btn-primary w-100">Enviar</button>
    </form>

    <div class="scanner-container mt-3" id="scanner-container">
        <video id="video"></video>
        <p class="text-muted mt-2">Alinea el c√≥digo dentro de la franja</p>
    </div>
</div>

<script>
    document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
    let currentInput = '';
    let codeReader = null;

    function startScanner(inputId) {
        currentInput = inputId;
        document.getElementById('scanner-container').style.display = 'block';

        codeReader = new ZXing.BrowserBarcodeReader();
        codeReader.decodeOnceFromVideoDevice(undefined, 'video')
        .then(result => {
            document.getElementById(currentInput).value = result.text;
            calcularCantidad();
            stopScanner();
        })
        .catch(err => console.error(err));
    }

    function stopScanner() {
        if (codeReader) {
            codeReader.reset();
            document.getElementById('scanner-container').style.display = 'none';
        }
    }

    function scanFromImage(event, inputId) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new ZXing.BrowserBarcodeReader();
        reader.decodeFromImageUrl(URL.createObjectURL(file))
            .then(result => {
                document.getElementById(inputId).value = result.text;
                calcularCantidad();
            })
            .catch(() => alert("No se pudo detectar el c√≥digo, intenta recortar mejor la imagen."));
    }

    function calcularCantidad() {
        let inicioStr = document.getElementById('serieInicio').value;
        let finStr = document.getElementById('serieFinal').value;
        let inicio = parseInt(inicioStr.slice(-4)) || 0;
        let fin = parseInt(finStr.slice(-4)) || 0;
        let cantidad = 0;
        if (inicio > 0 && fin > 0 && fin >= inicio) cantidad = (fin - inicio) + 1;
        document.getElementById('cantidad').value = cantidad;
    }

    document.getElementById("chipForm").addEventListener("submit", function(e){
        e.preventDefault();

        const formData = {
            nombre: this.nombre.value,
            dni: this.dni.value,
            punto: this.punto.value,
            celular: this.celular.value,
            serieInicio: this.serieInicio.value,
            serieFinal: this.serieFinal.value,
            cantidad: this.cantidad.value,
            fecha: this.fecha.value
        };

        fetch("https://script.google.com/macros/s/AKfycbwAAAL_zV2NVafrs-4lu8WzKQ0ls_sWI-9rfzXUAdLxHCbZFwOYy4ltmRkjCXUY1hn_/exec", {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        }).then(() => {
            alert("Datos enviados y guardados en Google Sheets ‚úÖ");
            this.reset();
            document.getElementById('cantidad').value = '';
            document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
        }).catch(() => {
            alert("‚ùå Error al enviar los datos");
        });
    });
</script>
</body>
</html>
