<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Chips</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 600px; margin-top: 30px; }
        .scanner-container { display: none; margin-top: 10px; }
        .readonly-input { background-color: #e9ecef; }
        #scanner { width: 100%; height: 300px; border: 2px solid #007bff; }
    </style>
</head>
<body>
<div class="container shadow p-4 bg-white rounded">
    <h3 class="text-center">Formulario de Registro de Chips</h3>
    <form id="chipForm">
        <div class="mb-3"><label class="form-label">Nombre</label>
            <input type="text" name="nombre" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">DNI</label>
            <input type="text" name="dni" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Punto de Venta</label>
            <input type="text" name="punto" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Celular</label>
            <input type="text" name="celular" class="form-control"></div>
        <div class="mb-3"><label class="form-label">Serie Inicio</label>
            <div class="input-group">
                <input type="text" id="serieInicio" class="form-control" oninput="calcularCantidad()">
                <button type="button" class="btn btn-outline-secondary" onclick="startScanner('serieInicio')">ðŸ“·</button>
            </div>
        </div>
        <div class="mb-3"><label class="form-label">Serie Final</label>
            <div class="input-group">
                <input type="text" id="serieFinal" class="form-control" oninput="calcularCantidad()">
                <button type="button" class="btn btn-outline-secondary" onclick="startScanner('serieFinal')">ðŸ“·</button>
            </div>
        </div>
        <div class="mb-3"><label class="form-label">Cantidad de ICID</label>
            <input type="text" id="cantidad" class="form-control readonly-input" readonly></div>
        <div class="mb-3"><label class="form-label">Fecha de Registro</label>
            <input type="text" id="fecha" class="form-control readonly-input" readonly></div>
        <button type="submit" class="btn btn-primary w-100">Enviar</button>
    </form>

    <div class="scanner-container mt-3" id="scanner"></div>
</div>

<script>
    document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
    let currentInput = '';

    function startScanner(inputId) {
        currentInput = inputId;
        document.getElementById('scanner').style.display = 'block';

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#scanner'),
                constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["ean_reader", "code_128_reader"] },
            locate: true,
            locator: { patchSize: "medium", halfSample: true }
        }, function(err) {
            if (err) { 
                alert("Error al iniciar cÃ¡mara: " + err); 
                return; 
            }
            Quagga.start();
        });

        Quagga.onProcessed(function(result) {
            const drawingCtx = Quagga.canvas.ctx.overlay;
            const drawingCanvas = Quagga.canvas.dom.overlay;

            if (result && result.boxes) {
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                result.boxes
                    .filter(box => box !== result.box)
                    .forEach(box => {
                        Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, {
                            color: 'green',
                            lineWidth: 2
                        });
                    });
            }

            if (result && result.box) {
                Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, {
                    color: '#FF0000',
                    lineWidth: 3
                });
            }
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            document.getElementById(currentInput).value = code;
            calcularCantidad();
            stopScanner();
        });
    }

    function stopScanner() {
        Quagga.stop();
        document.getElementById('scanner').style.display = 'none';
    }

    function calcularCantidad() {
        let inicioStr = document.getElementById('serieInicio').value;
        let finStr = document.getElementById('serieFinal').value;
        let inicio = parseInt(inicioStr.slice(-4)) || 0;
        let fin = parseInt(finStr.slice(-4)) || 0;
        let cantidad = 0;
        if (inicio > 0 && fin > 0 && fin >= inicio) cantidad = (fin - inicio) + 1;
        document.getElementById('cantidad').value = cantidad;
    }

    document.getElementById("chipForm").addEventListener("submit", function(e){
        e.preventDefault();
        alert("Datos enviados correctamente âœ…");
        this.reset();
        document.getElementById('cantidad').value = '';
        document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
    });
</script>
</body>
</html>
