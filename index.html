<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Chips</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 600px; margin-top: 20px; }
        video { width: 100%; height: 250px; border: 2px solid #007bff; object-fit: cover; }
        .readonly-input { background-color: #e9ecef; }
        #crop-container { display: none; text-align: center; margin-top: 10px; }
        #preview { max-width: 100%; max-height: 300px; }
    </style>
</head>
<body>
<div class="container shadow p-4 bg-white rounded">
    <h3 class="text-center">Formulario de Registro de Chips</h3>
    <form id="chipForm">
        <div class="mb-3"><label class="form-label">Nombre</label>
            <input type="text" name="nombre" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">DNI</label>
            <input type="text" name="dni" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Punto de Venta</label>
            <input type="text" name="punto" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Celular</label>
            <input type="text" name="celular" class="form-control"></div>

        <!-- Serie Inicio -->
        <div class="mb-3">
            <label class="form-label">Serie Inicio</label>
            <input type="text" id="serieInicio" class="form-control mb-2" oninput="calcularCantidad()">
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary w-50 me-1" onclick="startScanner('serieInicio')">üì∑ Escanear</button>
                <button type="button" class="btn btn-outline-info w-50" onclick="takePhoto('serieInicio')">üì∏ Tomar Foto</button>
            </div>
        </div>

        <!-- Serie Final -->
        <div class="mb-3">
            <label class="form-label">Serie Final</label>
            <input type="text" id="serieFinal" class="form-control mb-2" oninput="calcularCantidad()">
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary w-50 me-1" onclick="startScanner('serieFinal')">üì∑ Escanear</button>
                <button type="button" class="btn btn-outline-info w-50" onclick="takePhoto('serieFinal')">üì∏ Tomar Foto</button>
            </div>
        </div>

        <!-- Cantidad -->
        <div class="mb-3"><label class="form-label">Cantidad de ICID</label>
            <input type="text" id="cantidad" class="form-control readonly-input" readonly></div>
        <div class="mb-3"><label class="form-label">Fecha de Registro</label>
            <input type="text" id="fecha" class="form-control readonly-input" readonly></div>
        <button type="submit" class="btn btn-primary w-100">Enviar</button>
    </form>

    <!-- Scanner -->
    <div class="mt-3" id="scanner-container" style="display:none;">
        <video id="video"></video>
        <div class="mt-2 d-flex justify-content-between">
            <button class="btn btn-warning w-50 me-1" onclick="toggleFlash()">üî¶ Linterna</button>
            <button class="btn btn-danger w-50" onclick="stopScanner()">‚ùå Cerrar</button>
        </div>
    </div>

    <!-- Cropper -->
    <div id="crop-container">
        <h5>Recorta la zona del c√≥digo</h5>
        <img id="preview">
        <div class="mt-2">
            <button type="button" class="btn btn-success" onclick="cropAndScan()">‚úÖ Escanear Recorte</button>
            <button type="button" class="btn btn-danger" onclick="cancelCrop()">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<script>
    document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
    let currentInput = '';
    let codeReader;
    let flashOn = false;
    let track;

    // ‚úÖ Scanner autom√°tico
    function startScanner(inputId) {
        currentInput = inputId;
        document.getElementById('scanner-container').style.display = 'block';
        codeReader = new ZXing.BrowserBarcodeReader();

        codeReader.decodeOnceFromVideoDevice({ facingMode: "environment" }, 'video')
        .then(result => {
            document.getElementById(currentInput).value = result.text;
            calcularCantidad();
            stopScanner();
        })
        .catch(err => console.error(err));
    }

    function stopScanner() {
        if (codeReader) codeReader.reset();
        document.getElementById('scanner-container').style.display = 'none';
    }

    function toggleFlash() {
        if (!track) return;
        flashOn = !flashOn;
        track.applyConstraints({ advanced: [{ torch: flashOn }] }).catch(() => alert("Linterna no soportada"));
    }

    // üì∏ Foto + Crop
    function takePhoto(fieldId) {
        let input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.capture = "environment";
        input.onchange = (e) => {
            let file = e.target.files[0];
            let reader = new FileReader();
            reader.onload = function(event) {
                let img = document.getElementById('preview');
                img.src = event.target.result;
                document.getElementById('crop-container').style.display = 'block';
                cropper = new Cropper(img, { aspectRatio: NaN });
                currentInput = fieldId;
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    function cropAndScan() {
        let canvas = cropper.getCroppedCanvas();
        let croppedImage = canvas.toDataURL();
        let reader = new ZXing.BrowserBarcodeReader();
        reader.decodeFromImageUrl(croppedImage)
            .then(result => {
                document.getElementById(currentInput).value = result.text;
                calcularCantidad();
                cancelCrop();
            })
            .catch(() => alert("No se pudo detectar el c√≥digo"));
    }

    function cancelCrop() {
        document.getElementById('crop-container').style.display = 'none';
        if (cropper) cropper.destroy();
    }

    function calcularCantidad() {
        let inicio = parseInt(document.getElementById('serieInicio').value.slice(-4)) || 0;
        let fin = parseInt(document.getElementById('serieFinal').value.slice(-4)) || 0;
        let cantidad = 0;
        if (inicio && fin && fin >= inicio) cantidad = (fin - inicio) + 1;
        document.getElementById('cantidad').value = cantidad;
    }

    document.getElementById("chipForm").addEventListener("submit", function(e){
        e.preventDefault();
        alert("Datos enviados correctamente ‚úÖ");
        this.reset();
        document.getElementById('cantidad').value = '';
        document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
    });
</script>
</body>
</html>
