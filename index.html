<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Chips</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 600px; margin-top: 20px; }
    #reader { width: 100%; margin-top: 10px; }
    #scanner-container { display: none; }
    video { width: 100%; height: 250px; border: 2px solid #007bff; }
  </style>
</head>
<body>
<div class="container shadow p-4 bg-white rounded">
  <h3 class="text-center">Formulario de Registro de Chips</h3>
  <form id="chipForm">
    <div class="mb-3">
      <label class="form-label">Nombre</label>
      <input type="text" name="nombre" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label">DNI</label>
      <input type="text" name="dni" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Punto de Venta</label>
      <input type="text" name="punto" class="form-control" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Celular</label>
      <input type="text" name="celular" class="form-control" />
    </div>

    <!-- Serie Inicio -->
    <div class="mb-3">
      <label class="form-label">Serie Inicio</label>
      <input type="text" id="serieInicio" class="form-control mb-2" oninput="calcularCantidad()" />
      <button type="button" class="btn btn-outline-secondary w-100" onclick="startScanner('serieInicio')">üì∑ Escanear</button>
    </div>

    <!-- Serie Final -->
    <div class="mb-3">
      <label class="form-label">Serie Final</label>
      <input type="text" id="serieFinal" class="form-control mb-2" oninput="calcularCantidad()" />
      <button type="button" class="btn btn-outline-secondary w-100" onclick="startScanner('serieFinal')">üì∑ Escanear</button>
    </div>

    <div class="mb-3">
      <label class="form-label">Cantidad de ICID</label>
      <input type="text" id="cantidad" class="form-control" readonly />
    </div>
    <div class="mb-3">
      <label class="form-label">Fecha de Registro</label>
      <input type="text" id="fecha" class="form-control" readonly />
    </div>
    <button type="submit" class="btn btn-primary w-100">Enviar</button>
  </form>

  <!-- Scanner -->
  <div class="mt-3" id="scanner-container">
    <div id="reader"></div>
    <div class="mt-2 d-flex justify-content-between">
      <button class="btn btn-warning w-50 me-1" onclick="toggleFlash()">üî¶ Linterna</button>
      <button class="btn btn-danger w-50" onclick="stopScanner()">‚ùå Cerrar</button>
    </div>
  </div>
</div>

<script>
  document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
  let html5QrCode;
  let currentInput = '';
  let flashOn = false;

  function startScanner(inputId) {
    currentInput = inputId;
    document.getElementById('scanner-container').style.display = 'block';
    html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 80 } },
          qrCodeMessage => {
            document.getElementById(currentInput).value = qrCodeMessage;
            calcularCantidad();
            stopScanner();
          }
        );
      }
    });
  }

  function stopScanner() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        document.getElementById('scanner-container').style.display = 'none';
      });
    }
  }

  function toggleFlash() {
    alert("La linterna se activar√° autom√°ticamente si tu c√°mara lo soporta.");
  }

  function calcularCantidad() {
    let inicio = parseInt(document.getElementById('serieInicio').value.slice(-4)) || 0;
    let fin = parseInt(document.getElementById('serieFinal').value.slice(-4)) || 0;
    let cantidad = 0;
    if (inicio && fin && fin >= inicio) cantidad = (fin - inicio) + 1;
    document.getElementById('cantidad').value = cantidad;
  }

  document.getElementById("chipForm").addEventListener("submit", function (e) {
    e.preventDefault();
    alert("Datos enviados correctamente ‚úÖ");
    this.reset();
    document.getElementById('cantidad').value = '';
    document.getElementById('fecha').value = new Date().toLocaleDateString('es-PE');
  });
</script>
</body>
</html>
